
name: All build

on:
  push:
    branches:
      - main
    paths:
      - Src/*
  workflow_dispatch:

jobs:
  allbuild:
    name: All builds
    runs-on: windows-latest
    strategy:
      fail-fast: true
      matrix:
        build_type:
          - client
          #- client-debug
          #- server
          #- server-debug
    steps:
      - uses: actions/checkout@v3
      - name: Validate ${{ matrix.build_type }}
        run: Third-party/BuildTools/Validate.bat ${{ matrix.build_type }}
        working-directory: ${{ github.workspace }}
  updateversion:
    name: Update build number
    runs-on: windows-latest
    needs:
      - allbuild
    steps:
      - uses: actions/checkout@v3
      - name: Increment build number
        id: new_version  
        shell: powershell
        run: |
          echo Workspace is ${{github.workspace}}
          Third-party/BuildTools/update_version.exe path:.\ updpath
          $version = Get-Content .\src\VERSION
          Write-Host "Now version is: $version"
          echo "version_value=${version}" >> $env:GITHUB_OUTPUT
          
      - name: Push changes
        uses: test-room-7/action-update-file@v1  
        if: steps.new_version.outputs.version_value && github.repository == 'Relicta-Team/ReSDK_A3.vr'
        with:
          file-path: |
            ./Src/VERSION
            ./Src/version.hpp
          commit-msg: Autoupdate to ${{steps.new_version.outputs.version_value}}
          github-token: ${{secrets.TOKEN}}
      
      - name: postcheck
        run: |
         $version = Get-Content .\src\VERSION
         Write-Host "Version is: $version"
