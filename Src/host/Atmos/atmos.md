

# Описание
Система Atmos реализует симуляцию и распространение газов, воды и огня.
В текущей реализации 0.15.0 данная система имеет огромные накладыне расходы по производительности.
Обновление системы, описанное в этом файле объясняет как можно оптимизировать эту систему.

## Основные способы оптимизации
### Сервер
- создание и удаление объектов с низким сроком жизни с помощью hashmap objects
- формирование пакетов клиентам без лишних данных: айди и состояние
### Клиент
- отсечение рендеринга атмосферных частиц
- кешированное создание объектов для рендеринга освещения.
- прием от сервера упрощенных пакетов (айди чанка и состояние вместо полного пакета, принимаемого из NOEngine)

# Распределение зон
Для оптимизации чанков атмосферы их нужно разделить на сектора. причем из-за того, что атмос представлен в 3х мерном измерении чанки грузятся вокруг персонажа.

Первичный вариант: 11 чанков - 2 сверху и снизу, 1 в центре и по 1 с каждой стороны от персонажа
При смещении персонажа в новый чанк происходит перегрузка зоны.
Зоны представлены размером CHUNK_SIZE * CHUNK_AREA_SIZE - где размер зоны можно модифицировать через конфиг

# передача данных
Данные передаются большими пакетами. только в моменты обновления (1 раз в секунду)

Для минимизации отправки данных мы должны отправлять только айди чанков

Передача происходит по следующему алгоритму:
1. Клиент запрашивает зону. если зона не существует - она генерирует новую пустую зону.
2. Зона возвращает клиенту данные:
	[zoneid,lastupd,lastdel,id1,light_cfg,id2,light_cfg]
3. зона парсится. айди являются локальным смещением зоны. несколько айди могут применить несколько конфигов света (в будущем)
При обновлении следующее:
1. клиент отправляет запрос обновления с параметрами
	[netid,zoneid,ticktime]
2. сервер генерирует ответ.
	[zoneid,newticktime,lastdel,id1,-1,id2,light_cfg,id3,-1]
	следующий после айди флаг означает что нужно удалить конфигурации

Когда в зоне удаляется чанк и клиент возвращается в него:
1. клиент отправляет стандартный запрос обновления
	[netid,zoneid,ticktime]
2. сервер отдает стандартный пакет
	[zoneid,newticktime,lastdel,...]
3. смотрится значение lastdel. если оно отлично от юзерского времени последнего удаления то делаем 4
4. отправляем ещё реквест серверу на сверку
	[netid,zoneid,id1,id2...]
5. сервер генерирует ответный пакет формируя список на удаление.

## оптимизация отправки
у нас в каждой зоне есть 2 дельты
- время последнего изменения
- время последнего удаления
При обновлении зоны у каждого чанка с этого пакета обновляется метка последнего изменения.